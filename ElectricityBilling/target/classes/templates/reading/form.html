<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="fragments/layout :: html (~{::title}, ~{::body})">
<head><title>New Reading</title></head>
<body>
<h3>Add Reading</h3>
<form method="post" th:action="@{/readings}" th:object="${reading}">
  <div class="mb-3">
    <label class="form-label">Customer</label>
    <select class="form-select" th:field="*{customer.id}" required>
      <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.name + ' (' + c.meterNo + ')'}"></option>
    </select>
  </div>
  <div class="mb-3"><label class="form-label">Period Start</label><input class="form-control" type="date" th:field="*{periodStart}" required></div>
  <div class="mb-3"><label class="form-label">Period End</label><input class="form-control" type="date" th:field="*{periodEnd}" required></div>
  <div class="mb-3"><label class="form-label">Previous Reading (kWh)</label><input class="form-control" type="number" th:field="*{previousReadingKwh}" required></div>
  <div class="mb-3"><label class="form-label">Current Reading (kWh)</label><input class="form-control" id="currentK" type="number" th:field="*{currentReadingKwh}" required></div>
<div class="alert alert-info" id="estBox" style="display:none;">
  <div><b>Estimated Units:</b> <span id="estUnits">0</span></div>
  <div><b>Estimated Total (â‚¹):</b> <span id="estTotal">0.00</span></div>
</div>

  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
  <button class="btn btn-success">Save</button>
</form>

<script th:inline="javascript">
/*<![CDATA[*/
(function(){
  const prev = document.querySelector('[name="previousReadingKwh"]');
  const curr = document.getElementById('currentK');
  const box = document.getElementById('estBox');
  const u = document.getElementById('estUnits');
  const t = document.getElementById('estTotal');
  const tariffs = /*[[${tariffs}]]*/ [];

  function calc(){
    const p = parseInt(prev.value||'0',10);
    const c = parseInt(curr.value||'0',10);
    const units = Math.max(0, c - p);

    let energy = 0;
    let fixed = 0;

    if (units > 0) {
        const tariff = tariffs.find(t => units >= t.slabStartKwh && (t.slabEndKwh === null || units < t.slabEndKwh));
        if (tariff) {
            energy = units * tariff.ratePerKwh;
            fixed = tariff.fixedCharge;
        }
    }

    const total = Math.round((energy + fixed) * 100)/100;
    u.textContent = units;
    t.textContent = total.toFixed(2);
    box.style.display = (units > 0 ? 'block' : 'none');
  }

  prev.addEventListener('input', calc);
  curr.addEventListener('input', calc);
})();
/*]]>*/
</script>
<a class="btn btn-secondary mt-3" href="/dashboard">Back</a>
</body>
</html>
